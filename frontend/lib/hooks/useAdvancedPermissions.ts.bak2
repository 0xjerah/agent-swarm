'use client';

import { useCallback, useState } from 'react';
import { useAccount, useChainId, useWalletClient } from 'wagmi';
import type {
  PermissionRequest,
  Permission,
  GrantPermissionsResponse,
} from '../types/permissions';
import { parseUnits } from 'viem';

/**
 * Hook for ERC-7715 Advanced Permissions
 * Based on latest MetaMask Smart Accounts Kit specifications
 */
export function useAdvancedPermissions() {
  const { address, connector } = useAccount();
  const chainId = useChainId();
  const [isRequesting, setIsRequesting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [permissionsContext, setPermissionsContext] = useState<string | null>(null);

  /**
   * Get provider from connector
   */
  const getProvider = useCallback(async () => {
    if (!connector) {
      throw new Error('Wallet connector not available');
    }
    return await connector.getProvider();
  }, [connector]);

  /**
   * Request ERC-20 token transfer permissions with rate limiting
   */
  const requestERC20Permissions = useCallback(
    async (
      token: `0x${string}`,
      spender: `0x${string}`,
      allowanceAmount: string,
      durationSeconds: number = 30 * 24 * 60 * 60 // 30 days default
    ): Promise<GrantPermissionsResponse | null> => {
      if (!address) {
        setError('Wallet not connected');
        return null;
      }

      if (!connector) {
        setError('Wallet connector not available');
        return null;
      }

      setIsRequesting(true);
      setError(null);

      try {
        const expiry = Math.floor(Date.now() / 1000) + durationSeconds;

        // Build ERC-7715 compliant permission request
        const permission: Permission = {
          type: 'erc20-token-transfer',
          data: {
            token: token,
          },
          policies: [
            {
              type: 'token-allowance',
              data: {
                allowance: parseUnits(allowanceAmount, 6).toString(), // USDC has 6 decimals
              },
            },
          ],
        };

        const permissionRequest: PermissionRequest = {
          account: address,
          expiry: expiry,
          permissions: [permission],
        };

        console.log('Requesting ERC-7715 permissions:', permissionRequest);

        // Get provider from connector
        const provider = await connector.getProvider();

        // Request permissions using wallet_grantPermissions
        const result = await (provider as any).request({
          method: 'wallet_grantPermissions',
          params: [permissionRequest],
        });

        console.log('Permissions granted:', result);

        if (result && typeof result === 'object' && 'context' in result) {
          const response = result as GrantPermissionsResponse;
          setPermissionsContext(response.context);
          setIsRequesting(false);
          return response;
        }

        setIsRequesting(false);
        return result as GrantPermissionsResponse;
      } catch (err: any) {
        console.error('Error requesting permissions:', err);

        // Handle specific MetaMask errors
        if (err.code === 4001) {
          setError('User rejected the permission request');
        } else if (err.code === -32601) {
          setError('wallet_grantPermissions method not supported. Please use MetaMask with ERC-7715 support.');
        } else {
          setError(err.message || 'Failed to request permissions');
        }

        setIsRequesting(false);
        return null;
      }
    },
    [address, connector]
  );

  /**
   * Request native token (ETH) transfer permissions
   */
  const requestNativeTokenPermissions = useCallback(
    async (
      allowanceAmount: string, // in ETH
      durationSeconds: number = 30 * 24 * 60 * 60
    ): Promise<GrantPermissionsResponse | null> => {
      if (!address) {
        setError('Wallet not connected');
        return null;
      }

      if (!connector) {
        setError('Wallet connector not available');
        return null;
      }

      setIsRequesting(true);
      setError(null);

      try {
        const expiry = Math.floor(Date.now() / 1000) + durationSeconds;

        const permission: Permission = {
          type: 'native-token-transfer',
          data: {
            ticker: 'ETH',
          },
          policies: [
            {
              type: 'token-allowance',
              data: {
                allowance: parseUnits(allowanceAmount, 18).toString(),
              },
            },
          ],
        };

        const permissionRequest: PermissionRequest = {
          account: address,
          expiry: expiry,
          permissions: [permission],
        };

        console.log('Requesting native token permissions:', permissionRequest);

        const result = await (walletClient.request as any)({
          method: 'wallet_grantPermissions',
          params: [permissionRequest],
        });

        console.log('Permissions granted:', result);

        if (result && typeof result === 'object' && 'context' in result) {
          const response = result as GrantPermissionsResponse;
          setPermissionsContext(response.context);
          setIsRequesting(false);
          return response;
        }

        setIsRequesting(false);
        return result as GrantPermissionsResponse;
      } catch (err: any) {
        console.error('Error requesting native token permissions:', err);
        setError(err.message || 'Failed to request permissions');
        setIsRequesting(false);
        return null;
      }
    },
    [address, connector]
  );

  /**
   * Request contract call permissions for Master Agent
   */
  const requestMasterAgentPermissions = useCallback(
    async (
      masterAgentAddress: `0x${string}`,
      token: `0x${string}`,
      dailyLimit: string,
      durationDays: number = 30
    ): Promise<GrantPermissionsResponse | null> => {
      if (!address) {
        setError('Wallet not connected');
        return null;
      }

      if (!connector) {
        setError('Wallet connector not available');
        return null;
      }

      setIsRequesting(true);
      setError(null);

      try {
        const expiry = Math.floor(Date.now() / 1000) + durationDays * 86400;

        // Permission for ERC-20 transfers via the Master Agent
        const permission: Permission = {
          type: 'erc20-token-transfer',
          data: {
            token: token,
          },
          policies: [
            {
              type: 'token-allowance',
              data: {
                allowance: parseUnits(dailyLimit, 6).toString(),
              },
            },
            {
              type: 'rate-limit',
              data: {
                count: 1,
                interval: 86400, // Daily limit
              },
            },
          ],
        };

        const permissionRequest: PermissionRequest = {
          account: address,
          expiry: expiry,
          permissions: [permission],
        };

        console.log('Requesting master agent permissions:', permissionRequest);

        const result = await (walletClient.request as any)({
          method: 'wallet_grantPermissions',
          params: [permissionRequest],
        });

        console.log('Master agent permissions granted:', result);

        if (result && typeof result === 'object' && 'context' in result) {
          const response = result as GrantPermissionsResponse;
          setPermissionsContext(response.context);
          setIsRequesting(false);
          return response;
        }

        setIsRequesting(false);
        return result as GrantPermissionsResponse;
      } catch (err: any) {
        console.error('Error requesting master agent permissions:', err);
        setError(err.message || 'Failed to request permissions');
        setIsRequesting(false);
        return null;
      }
    },
    [address, connector]
  );

  /**
   * Revoke permissions (if supported)
   */
  const revokePermissions = useCallback(
    async (context: string): Promise<boolean> => {
      if (!address) {
        setError('Wallet not connected');
        return false;
      }

      if (!connector) {
        setError('Wallet connector not available');
        return false;
      }

      try {
        await (walletClient.request as any)({
          method: 'wallet_revokePermissions',
          params: [{ context }],
        });

        console.log('Permissions revoked');
        setPermissionsContext(null);
        return true;
      } catch (err: any) {
        console.error('Error revoking permissions:', err);
        setError(err.message || 'Failed to revoke permissions');
        return false;
      }
    },
    [address, connector]
  );

  /**
   * Check if ERC-7715 is supported
   */
  const checkSupport = useCallback(async (): Promise<boolean> => {
    if (!walletClient) return false;

    try {
      // Try to get wallet capabilities
      const capabilities = await (walletClient.request as any)({
        method: 'wallet_getCapabilities',
        params: [address],
      });

      console.log('Wallet capabilities:', capabilities);
      return true;
    } catch (err) {
      console.warn('ERC-7715 may not be supported:', err);
      return false;
    }
  }, [address, connector]);

  return {
    requestERC20Permissions,
    requestNativeTokenPermissions,
    requestMasterAgentPermissions,
    revokePermissions,
    checkSupport,
    isRequesting,
    error,
    permissionsContext,
  };
}
